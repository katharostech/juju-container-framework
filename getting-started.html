<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Getting Started - Lucky - A charming framework for Juju</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="overview.html">Overview</a></li><li class="expanded "><a href="getting-started.html" class="active"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="spacer"></li><li class="expanded "><a href="lucky-development/index.html"><strong aria-hidden="true">2.</strong> Lucky Development</a></li><li><ol class="section"><li class="expanded "><a href="lucky-development/design.html"><strong aria-hidden="true">2.1.</strong> Design</a></li><li class="expanded "><a href="lucky-development/building.html"><strong aria-hidden="true">2.2.</strong> Development</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="cli/lucky.html"><strong aria-hidden="true">3.</strong> Lucky CLI</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/charm.html"><strong aria-hidden="true">3.1.</strong> charm</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/charm/build.html"><strong aria-hidden="true">3.1.1.</strong> build</a></li><li class="expanded "><a href="cli/lucky/charm/create.html"><strong aria-hidden="true">3.1.2.</strong> create</a></li></ol></li><li class="expanded "><a href="cli/lucky/client.html"><strong aria-hidden="true">3.2.</strong> client</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/set-status.html"><strong aria-hidden="true">3.2.1.</strong> set-status</a></li><li class="expanded "><a href="cli/lucky/client/kv.html"><strong aria-hidden="true">3.2.2.</strong> kv</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/kv/get.html"><strong aria-hidden="true">3.2.2.1.</strong> get</a></li><li class="expanded "><a href="cli/lucky/client/kv/set.html"><strong aria-hidden="true">3.2.2.2.</strong> set</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/container.html"><strong aria-hidden="true">3.2.3.</strong> container</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/container/image.html"><strong aria-hidden="true">3.2.3.1.</strong> image</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/container/image/get.html"><strong aria-hidden="true">3.2.3.1.1.</strong> get</a></li><li class="expanded "><a href="cli/lucky/client/container/image/set.html"><strong aria-hidden="true">3.2.3.1.2.</strong> set</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/container/apply-updates.html"><strong aria-hidden="true">3.2.3.2.</strong> apply-updates</a></li><li class="expanded "><a href="cli/lucky/client/container/env.html"><strong aria-hidden="true">3.2.3.3.</strong> env</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/container/env/get.html"><strong aria-hidden="true">3.2.3.3.1.</strong> get</a></li><li class="expanded "><a href="cli/lucky/client/container/env/set.html"><strong aria-hidden="true">3.2.3.3.2.</strong> set</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/container/set-entrypoint.html"><strong aria-hidden="true">3.2.3.4.</strong> set-entrypoint</a></li><li class="expanded "><a href="cli/lucky/client/container/set-command.html"><strong aria-hidden="true">3.2.3.5.</strong> set-command</a></li><li class="expanded "><a href="cli/lucky/client/container/volume.html"><strong aria-hidden="true">3.2.3.6.</strong> volume</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/container/volume/remove.html"><strong aria-hidden="true">3.2.3.6.1.</strong> remove</a></li><li class="expanded "><a href="cli/lucky/client/container/volume/add.html"><strong aria-hidden="true">3.2.3.6.2.</strong> add</a></li><li class="expanded "><a href="cli/lucky/client/container/volume/get.html"><strong aria-hidden="true">3.2.3.6.3.</strong> get</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/container/delete.html"><strong aria-hidden="true">3.2.3.7.</strong> delete</a></li><li class="expanded "><a href="cli/lucky/client/container/port.html"><strong aria-hidden="true">3.2.3.8.</strong> port</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/container/port/add.html"><strong aria-hidden="true">3.2.3.8.1.</strong> add</a></li><li class="expanded "><a href="cli/lucky/client/container/port/remove.html"><strong aria-hidden="true">3.2.3.8.2.</strong> remove</a></li><li class="expanded "><a href="cli/lucky/client/container/port/list.html"><strong aria-hidden="true">3.2.3.8.3.</strong> list</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/container/set-network.html"><strong aria-hidden="true">3.2.3.9.</strong> set-network</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/public-address.html"><strong aria-hidden="true">3.2.4.</strong> public-address</a></li><li class="expanded "><a href="cli/lucky/client/private-address.html"><strong aria-hidden="true">3.2.5.</strong> private-address</a></li><li class="expanded "><a href="cli/lucky/client/get-config.html"><strong aria-hidden="true">3.2.6.</strong> get-config</a></li><li class="expanded "><a href="cli/lucky/client/port.html"><strong aria-hidden="true">3.2.7.</strong> port</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/port/open.html"><strong aria-hidden="true">3.2.7.1.</strong> open</a></li><li class="expanded "><a href="cli/lucky/client/port/close.html"><strong aria-hidden="true">3.2.7.2.</strong> close</a></li><li class="expanded "><a href="cli/lucky/client/port/get-opened.html"><strong aria-hidden="true">3.2.7.3.</strong> get-opened</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/relation.html"><strong aria-hidden="true">3.2.8.</strong> relation</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/relation/get.html"><strong aria-hidden="true">3.2.8.1.</strong> get</a></li><li class="expanded "><a href="cli/lucky/client/relation/set.html"><strong aria-hidden="true">3.2.8.2.</strong> set</a></li><li class="expanded "><a href="cli/lucky/client/relation/list-units.html"><strong aria-hidden="true">3.2.8.3.</strong> list-units</a></li><li class="expanded "><a href="cli/lucky/client/relation/list-ids.html"><strong aria-hidden="true">3.2.8.4.</strong> list-ids</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/leader.html"><strong aria-hidden="true">3.2.9.</strong> leader</a></li><li><ol class="section"><li class="expanded "><a href="cli/lucky/client/leader/get.html"><strong aria-hidden="true">3.2.9.1.</strong> get</a></li><li class="expanded "><a href="cli/lucky/client/leader/set.html"><strong aria-hidden="true">3.2.9.2.</strong> set</a></li><li class="expanded "><a href="cli/lucky/client/leader/is-leader.html"><strong aria-hidden="true">3.2.9.3.</strong> is-leader</a></li></ol></li><li class="expanded "><a href="cli/lucky/client/random.html"><strong aria-hidden="true">3.2.10.</strong> random</a></li><li class="expanded "><a href="cli/lucky/client/get-resource.html"><strong aria-hidden="true">3.2.11.</strong> get-resource</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Lucky - A charming framework for Juju</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/katharostech/lucky" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-github"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#getting-started" id="getting-started">Getting Started</a></h1>
<p>Welcome to the getting started guide for the Lucky charming framework. Here we will walk through the process of creating a charm for <a href="https://github.com/hackmdio/codimd">CodiMD</a>. This charm will provide an <code>http</code> interface, allowing you to hook it up to other charms such as <a href="https://jaas.ai/haproxy">HAProxy</a> for load balancing. The charm will also require a <code>pgsql</code> interface which we will use to connect the charm to a <a href="https://jaas.ai/postgresql">PostgreSQL</a> database charm.</p>
<p>You can find the entire source for the charm we will be writing in this tutorial <a href="https://github.com/katharostech/lucky/tree/master/docs/book/src/codimd-example-charm">here</a>.</p>
<h2><a class="header" href="#installing-required-tools" id="installing-required-tools">Installing Required Tools</a></h2>
<p>Before we get started, we are going to need some tools. Juju development is usually done on Linux and this guide will assume that you are working in a Linux environment. While it is possible to develop charms on Windows, if you already have a Juju cluster, it currently isn't the easiest way to get started.</p>
<p>If your workstation is a Windows machine, the easiest way to develop charms is in a Linux <a href="https://www.vagrantup.com/">Vagrant</a> machine. It is outside of the scope of this tutorial to detail how to setup a Linux Vagrant machine.</p>
<blockquote>
<p><strong>Note:</strong> If already have a Juju cluster and you have the Juju CLI setup on Windows, you should be able to develop charms on Windows without a VM, but you might require more setup in order to install the charm tools. Even if you don't install the charm tools, you can still develop your charm, you just won't be able to push it to the store.</p>
<p>This is not very tested yet. If you need help getting setup you can open a <a href="https://discourse.jujucharms.com/c/related-software/lucky">forum topic</a>.</p>
</blockquote>
<h3><a class="header" href="#juju" id="juju">Juju</a></h3>
<p>The first step is to setup a Juju development cluster. See the <a href="https://jaas.ai/docs/getting-started-with-juju">Juju getting started guide</a> for more information.</p>
<h3><a class="header" href="#charm-tools" id="charm-tools">Charm Tools</a></h3>
<p>The <a href="https://github.com/juju/charm-tools">charm tools</a> CLI is what we will use to push our charm to the charm store. It can be installed with its <a href="https://snapcraft.io/charm">snap</a>:</p>
<pre><code>sudo snap install charm --classic
</code></pre>
<p>You can skip installing the charm tools if you don't want to push charms to the store.</p>
<h3><a class="header" href="#lucky" id="lucky">Lucky</a></h3>
<p>Now we install Lucky itself. You can download Lucky from the GitHub <a href="https://github.com/katharostech/lucky/releases">releases</a> page. Lucky will eventually support at least the Snap package manager, but for now you can also use this one-liner to install Lucky:</p>
<pre><code>curl -L https://github.com/katharostech/lucky/releases/download/v0.1.0-alpha.0/lucky-linux-x86_64.tgz | sudo tar -xzC /usr/local/bin/
</code></pre>
<p>You can verify that the install worked:</p>
<pre><code>$ lucky --version
lucky v0.1.0-alpha.0
</code></pre>
<h2><a class="header" href="#creating-your-charm" id="creating-your-charm">Creating Your Charm</a></h2>
<p>Now that we have the required tools, we can create our charm. Lucky comes with a built-in charm template that you can use:</p>
<pre><code class="language-bash">$ lucky charm create codimd
Display name [codimd]: Codimd
Charm name [codimd]: 
Charm summary [A short summary of my app.]: A realtime collaborative notes platform.
Charm maintainer [John Doe &lt;johndoe@emailprovider.com&gt;]: My Name &lt;myname@myprovider.com&gt;
</code></pre>
<p>This will create a new dir named <code>codimd</code> with the metadata that you filled in and some example code.</p>
<h2><a class="header" href="#configuring-charm-metadata" id="configuring-charm-metadata">Configuring Charm Metadata</a></h2>
<p>Lets first take a look at that metadata:</p>
<h3><a class="header" href="#metadatayaml" id="metadatayaml"><code>metadata.yaml</code></a></h3>
<pre><code class="language-yaml">name: codimd
display-name: Codimd
summary: A realtime collaborative notes platform.
maintainer: My Name &lt;myname@myprovider.com&gt;
description: |
  A realtime collaborative notes platform.
tags:
  # Replace &quot;misc&quot; with one or more whitelisted tags from this list:
  # https://jujucharms.com/docs/stable/authors-charm-metadata
  - misc
subordinate: false
provides:
  provides-relation:
    interface: interface-name
requires:
  requires-relation:
    interface: interface-name
peers:
  peer-relation:
    interface: interface-name
</code></pre>
<p>That pretty much has what we need, but we will want to change those fake relations to the ones that we actually need. Go ahead and remove the <code>provides</code>, <code>requires</code>, and <code>peers</code> sections and replace them with this:</p>
<pre><code class="language-yaml">provides:
  website:
    interface: http
requires:
  database:
    interface: pgsql
</code></pre>
<p>With this we tell Juju that:</p>
<ul>
<li>we have a <code>website</code> relation that we <code>provide</code> and the way we interact with that relation conforms to the <code>http</code> interface.</li>
<li>we have a <code>database</code> relation that we <code>require</code> and the way we interact with that relation conforms to the <code>pgsql</code> interface.</li>
</ul>
<p>Interfaces are names for the way in which a charm will communicate over a relation. Only relations with the same interface will be allowed to be connected to each-other. This means there is no way to accidentally connect a requires <code>pgsql</code> relation to a charm that only provides <code>redis</code>.</p>
<p>You can find documentation for some interfaces in the <a href="https://discourse.jujucharms.com/c/docs/interfaces">Juju interfaces docs</a>.</p>
<p>Next we'll look at our config.</p>
<h3><a class="header" href="#configyaml" id="configyaml"><code>config.yaml</code></a></h3>
<p>The template config yaml looks like this:</p>
<pre><code class="language-yaml"># These are config values that users can set from the GUI or the commandline
options:
  name:
    type: string
    default: John
    description: The name of something
  enable-something:
    type: boolean
    default: False
    description: Whether or not to enable something
  count:
    type: int
    default: 100
    description: How much of something
</code></pre>
<p>The purpose of <code>config.yaml</code> is to define the options to our charm that users are allowed to change. We can see all of the available config options for CodiMD in their <a href="https://github.com/codimd/server/blob/master/docs/configuration-env-vars.md">documentation</a>. For now we'll just give some of the minimal essential options in our <code>config.yaml</code>. Also, note that we don't need to put the database connection info in the config because we will use Juju's relations to automatically configure the database connection.</p>
<pre><code class="language-yaml">options:
  domain:
    type: string
    default: example.org
    description: The domain CodiMD is hosted under
  url-path:
    type: string
    default: &quot;&quot;
    description: If CodiMD is run from a subdirectory like &quot;www.example.com/&lt;urlpath&gt;&quot;
  port:
    type: int
    default: 9000
    description: The port to host CodiMD on
  https:
    type: boolean
    default: false
    description: Whether or not the server will be accessed over HTTPS
</code></pre>
<p>That config will give us enough information for us to get started, but if we wanted to make a general-purpose charm for the community we would want to add the rest of the configuration from the documentation.</p>
<h3><a class="header" href="#luckyyaml" id="luckyyaml"><code>lucky.yaml</code></a></h3>
<p>The final metadata file we are interested in is the <code>lucky.yaml</code> file. This file acts as your &quot;control panel&quot; so to speak when it comes to the execution of your charm logic. The job of the <code>lucky.yaml</code> is to tell lucky <em>when</em> and <em>how</em> to execute your charm scripts. The charm template comes with an example <code>lucky.yaml</code> that shows you everything that you can put in a <code>lucky.yaml</code> file. For the sake of this tutorial we are going to take everything out of the <code>lucky.yaml</code> and build on it as we go.</p>
<p><strong>lucky.yaml:</strong></p>
<pre><code class="language-yaml"># Nothing here yet!
</code></pre>
<h2><a class="header" href="#writing-your-first-script" id="writing-your-first-script">Writing Your First Script</a></h2>
<p>Now we are ready to write our first script! In Lucky there are two kinds of scripts, host scripts and container scripts, which are put in the <code>host_scripts/</code> and <code>container_scripts/</code> directories. The difference is that host scripts run on the host and container scripts are mounted and run inside of your containers. Our scripts for CodiMD will go in the <code>host_scripts/</code> dir.</p>
<p>You will notice that there are some scripts from the charm template already in the <code>hosts_scripts/</code> and <code>container_scripts/</code> dirs. These are just examples and you can remove them for this tutorial.</p>
<p>The first script that we will create for our charm is the install script. Note that the name of the script is arbitrary and you could call it whatever you want.</p>
<p><strong>install.sh:</strong></p>
<pre><code class="language-bash">#!/bin/bash

# Exit script early if any command in the script fails
set -e

# Set the status for this script so users can se what our charm is doing
lucky set-status maintenance &quot;Starting CodiMD&quot;

# Set the Docker image, this will cause lucky to create a container when this
# script exits
lucky container image set quay.io/codimd/server:1.6.0-alpine

# Set a named status that can be changed from other scripts.
# Here we notify the user that we need a database relation before CodiMD will work
lucky set-status --name db-state blocked &quot;Waiting for database connection&quot; 

# Clear the status for this script by setting the status to active without a message.
# This makes sure that our &quot;Starting CodiMD&quot; message goes away.
lucky set-status active
</code></pre>
<p>First notice that we have a &quot;shabang&quot;, as it is called, at the top of the file: <code>#!/bin/bash</code>. This tells the system to execute our file with bash. We also include a <code>set -e</code>, which will make sure that he script will exit early if any of the commands in it fail. Additionally we need to make our file executable by running <code>chmod +x install.sh</code>. This makes sure that Lucky will be able to execute the script when the charm runs.</p>
<p>After that we use the <code>lucky set-status</code> command set the Juju status, which will be visible in the Juju GUI.</p>
<p>Then we set the Docker container image with the <code>lucky container image set</code> command. Setting a container's image is the way to create a new contianer that will be deployed by Lucky automatically when our script exits. Additionally, when we change any container configuration, such as environment variables or port bindings, Lucky will wait until our script exits and then apply any changes that we have made. We will see more of how this works later.</p>
<h3><a class="header" href="#understanding-lucky-status" id="understanding-lucky-status">Understanding Lucky Status</a></h3>
<p>At this point the Lucky status mechanism should be explained. In Lucky, when you call <code>set-status</code>, by default, Lucky will set the given status <em>for only that script</em>. This means that if another script uses <code>set-status</code> it will not overwrite the status that the previous script set, but will instead <em>add</em> its status to the previous status by comma separating the list of all script status messages.</p>
<p>It is common pattern in Lucky scripts to have a <code>lucky set status maintenance &quot;Message&quot;</code> at the top  of the script and a <code>lucky set-status active</code> at the bottom. This makes sure that the user will be notified of the script's action, and that the action message will be cleared before the script exits.</p>
<p>Alternatively, when you set a status with a <code>--name &lt;name&gt;</code>, you can set that status from <em>any</em> script by specifying the same <code>--name</code>. In this exmple, we use a status with a <code>db-state</code> name that we use to indicate the status of our database connection. When the charm is first installed, it will not have a database relation, and we use this opportunity to tell the user that we need a database connection to work. Later, when we get a database connection in a <em>different</em> script, we will call <code>lucky set-status --name db-state active</code> to clear the blocked status.</p>
<h3><a class="header" href="#adding-our-script-to-the-luckyyaml" id="adding-our-script-to-the-luckyyaml">Adding Our Script to the <code>lucky.yaml</code></a></h3>
<p>Ok, so we now have a written script, but currently there is nothing instructing Lucky to run the script at any time. The script existing is <em>not</em> enough to cause it to run. That is why we add entries to the <code>lucky.yaml</code>, to tell Lucky when to run our scripts.</p>
<p>In this case, we want our <code>install.sh</code> host script to run when the Juju <code>install</code> hook is triggered:</p>
<p><strong>lucky.yaml:</strong></p>
<pre><code class="language-yaml"># Juju hooks
hooks:
  
  # When the charm is installed
  install:
    # Run our install.sh host script
    - host-script: install.sh
</code></pre>
<p>Pretty simple right? Now Lucky will run our <code>install.sh</code> host script whenever the Juju <code>install</code> hook is run.</p>
<p>Lets move on to the <code>configure.sh</code> script.</p>
<h2><a class="header" href="#writing-the-configuresh-script" id="writing-the-configuresh-script">Writing the <code>configure.sh</code> Script</a></h2>
<p>So we have our app installing, and actually starting ( becuse Lucky will start the container when we set the docker image ) with the <code>install.sh</code> script, but it won't really do anything because it doesn't have any of our configuration. That is what we are going to do with our <code>configure.sh</code> script. We are going to read the configuration values that we have defined in our <code>config.yaml</code> and use those values to set environment variables on our CodiMD container.</p>
<p><strong>configure.sh:</strong></p>
<pre><code class="language-bash">#!/bin/bash

set -e

lucky set-status maintenance &quot;Configuring CodiMD&quot;

# Get the config values and put them in shell variables
domain=&quot;$(lucky get-config domain)&quot;
url_path=&quot;$(lucky get-config url-path)&quot;
https=&quot;$(lucky get-config https)&quot;
add_port=&quot;$(lucky get-config add-port-to-domain)&quot;
port=&quot;$(lucky get-config port)&quot;

# Set the respective container environment variables
lucky container env set \
    &quot;CMD_DOMAIN=$domain&quot; \
    &quot;CMD_URL_PATH=$url_path&quot; \
    &quot;CMD_PORT=$port&quot; \
    &quot;CMD_PROTOCOL_USESSL=$https&quot; \
    &quot;CMD_URL_ADDPORT=false&quot; # This last config fixes issues when hosting on different ports

# Remove any mounted container ports that might have been added in previous
# runs of `configure.sh`.
lucky container port remove --all

# Mount configured port on the host to configured port in the container
lucky container port add &quot;$port:$port&quot;

# Clear any previously opened firewall ports
lucky port close --all

# Open the configured port on the firewall
lucky port open $port

lucky set-status active
</code></pre>
<p>In this script we introduce some extra <code>lucky</code> commands. As always, you can access extra information on those commands in the <a href="./cli/lucky/client.html">Lucky client</a> documentation.</p>
<blockquote>
<p><strong>Note:</strong> You can also access the CLI documentation from the Lucky CLI itself, by prefixing the command that we use in our script with <code>client</code> and adding the <code>--doc</code> flag. For example, you can run <code>lucky client get-config --doc</code> on your workstation to get terminal rendered view of the same CLI documentation available on this site. This can be very useful when needing to quickly look something up without using a web browser or the internet.</p>
</blockquote>
<p>Overall this script is pretty simple, when the config changes, we make sure that our container environment variables are up-to-date. Also we make sure that we mount the configured port on the host to the container.</p>
<p>When working with ports that are opened according to configuration values, we need to make sure that we <em>remove</em> any ports that were opened by previous configuration. This makes sure that we don't end up with multiple ports mounted into the container if the user changes the configured port and the <code>configure.sh</code> script is re-run.</p>
<h3><a class="header" href="#the-difference-between-lucky-container-port-and-lucky-port" id="the-difference-between-lucky-container-port-and-lucky-port">The Difference Between <code>lucky container port</code> and <code>lucky port</code></a></h3>
<p>You may notice in the above example that we do both a <code>lucky container port add</code> and a <code>lucky port open</code>, so what is the difference?</p>
<p><code>lucky contianer port add</code> will add a port binding from the host to the container. <code>lucky port open</code>, on the other hand, registers that port with Juju so that it will be opened through the host's <em>firewall</em> when users run <code>juju expose codimd</code>.</p>
<p>If you want to be able to communicate to a port only on the private network, such as app-to-app communication, you do <strong>not</strong> want to use <code>lucky open</code> because that will expose that port to the internet on the host's firewall. In such a case you will still need to use <code>lucky contianer port add</code> to make sure that the containers can communicate.</p>
<p>If you <em>do</em> want to be able to hit the port from the internet, though, like in the case of CodiMD, you <em>will</em> need to <code>lucky open port</code> <em>and</em> the users will need to <code>juju expose</code> the application before you can access that port.</p>
<h3><a class="header" href="#adding-configuresh-to-the-luckyyaml" id="adding-configuresh-to-the-luckyyaml">Adding <code>configure.sh</code> to the <code>lucky.yaml</code></a></h3>
<p>Now we can add <code>configure.sh</code> to the <code>lucky.yaml</code> just like we did with the <code>install.sh</code> script.</p>
<pre><code class="language-yaml"># Juju hooks
hooks:
  
  # When the charm is installed
  install:
    # Run our install.sh host script
    - host-script: install.sh
  
  # When configuration has been changed
  config-changed:
    # Run our configure.sh host script
    - host-script: configure.sh 
</code></pre>
<h2><a class="header" href="#handling-the-database-relation" id="handling-the-database-relation">Handling the Database Relation</a></h2>
<p>OK, so we now have our app and its user configuration. The next step is to setup the database relation. We will use the database relationship in Juju to automatically configure our database connection when the user runs <code>juju relate codimd postgresql:db</code>.</p>
<p>We are going to create a new script for handling the database relation:</p>
<p><strong>handle-datbase-relation.sh:</strong></p>
<pre><code class="language-bash">#!/bin/bash

set -e

# Set the database name
db_name=codimd

# Here we match on the first argument ( $1 ) passed in from the lucky.yaml

if [ &quot;$1&quot; = &quot;join&quot; ]; then
    lucky set-status --name db-state maintenance &quot;Connecting to database&quot;

    # Set the name of the database that we want the server to create for us
    lucky relation set &quot;database=$db_name&quot;

elif [ &quot;$1&quot; = &quot;update&quot; ]; then
    lucky set-status --name db-state maintenance &quot;Updating database connection&quot;

    # Get the values from the connected database relation
    dbhost=&quot;$(lucky relation get host)&quot;
    dbport=&quot;$(lucky relation get port)&quot;
    dbuser=&quot;$(lucky relation get user)&quot;
    dbpassword=&quot;$(lucky relation get password)&quot;

    # If any of those values have not be set yet, exit early and wait until next update
    if [ &quot;$dbhost&quot; = &quot;&quot; -o &quot;$dbport&quot; = &quot;&quot; -o &quot;$dbuser&quot; = &quot;&quot; -o &quot;$dbpassword&quot; = &quot;&quot; ]; then
        exit 0
    fi

    # Set database connection environment variable
    lucky container env set &quot;CMD_DB_URL=postgres://$dbuser:$dbpassword@$dbhost:$dbport/$db_name&quot;

    lucky set-status --name db-state active

elif [ &quot;$1&quot; = &quot;leave&quot; ]; then
    lucky set-status --name db-state maintenance &quot;Disconnecting from database&quot;

    # Unset database connection environment variable
    lucky container env set &quot;CMD_DB_URL=&quot;

    lucky set-status --name db-state blocked &quot;Waiting for database connection&quot;
fi
</code></pre>
<p>And here is the section we need in the <code>lucky.yaml</code> ( still under the <code>hooks</code> section ):</p>
<pre><code class="language-yaml">  # When we are related to a database
  database-relation-joined:
    # Run our database join handler
    - host-script: handle-database-relation.sh
      args: [&quot;join&quot;]

  # When the datbase relation changes
  database-relation-changed:
    - host-script: handle-database-relation.sh
      args: [&quot;update&quot;]
  
  # When we are disconnected from a database
  database-relation-departed:
    # Run our database departed handler
    - host-script: handle-database-relation.sh
      args: [&quot;leave&quot;]
</code></pre>
<p>This is a larger chunk of code to process so lets break it down a little:</p>
<h3><a class="header" href="#joining-the-database-relation" id="joining-the-database-relation">Joining the Database Relation</a></h3>
<p>To handle the database join relation we add this section to the <code>lucky.yaml</code>:</p>
<p><strong>lucky.yaml:</strong></p>
<pre><code class="language-yaml">  # When we are related to a database
  database-relation-joined:
    # Run our database join handler
    - host-script: handle-database-relation.sh
      args: [&quot;join&quot;]
</code></pre>
<p>We say that on the <code>database-relation-joined</code> hook we want to run the <code>handle-database-relation.sh</code> script and pass it <code>join</code> as its first argument. Inside of our <code>handle-database-relation.sh</code> script we then use an if statement to check whether the first argument ( <code>$1</code> ) is <code>join</code>:</p>
<p><strong>handle-database-relation.sh:</strong></p>
<pre><code class="language-bash">if [ &quot;$1&quot; = &quot;join&quot; ]; then
    lucky set-status --name db-state maintenance &quot;Connecting to database&quot;

    # Set the name of the database that we want the server to create for us
    lucky relation set &quot;database=$db_name&quot;
</code></pre>
<p>When the database relation is joined, we set our <code>db-state</code> status to <code>&quot;Connecting to database&quot;</code>. Also, following the <a href="https://discourse.jujucharms.com/t/interface-pgsql/2393#heading-con"><code>pgsql</code> interface documentation</a>, when we join a <code>pgsql</code> relation, it is the job of our charm to set the <code>database</code> key on the relation so the PostgreSQL charm knows what database to create for our application.</p>
<p>After we have set the <code>database</code> key on this relation, we will exit and wait until the next <code>database-relation-changed</code> hook is run at which point PostgreSQL will have set the database hostname, port, username, and password that we need to connect to it.</p>
<blockquote>
<p><strong>Note:</strong> Because our script is executing as a part of a relation hook, Lucky has extra context about <em>which</em> relation to set the <code>database</code> value for and we do not need to specify <em>which</em> because it will default to whatever relation triggered the run of the relation hook.</p>
<p>If you ever needed to <code>lucky relation set</code> or <code>lucky relation get</code> <em>outside</em> of a relation hook, then you will need to specify the relation <strong>id</strong> to set/get. You will see this later when we setup the <code>http</code> relation.</p>
</blockquote>
<h3><a class="header" href="#updating-the-database-relation" id="updating-the-database-relation">Updating the Database Relation</a></h3>
<p>Now we need to handle any updates that happen to our established PostgreSQL relation:</p>
<p><strong>lucky.yaml:</strong></p>
<pre><code class="language-yaml">  # When the datbase relation changes
  database-relation-changed:
    - host-script: handle-database-relation.sh
      args: [&quot;update&quot;]
</code></pre>
<p><strong>handle-database-relation.sh:</strong></p>
<pre><code class="language-bash">elif [ &quot;$1&quot; = &quot;update&quot; ]; then
    lucky set-status --name db-state maintenance &quot;Updating database connection&quot;

    # Get the values from the connected database relation
    dbhost=&quot;$(lucky relation get host)&quot;
    dbport=&quot;$(lucky relation get port)&quot;
    dbuser=&quot;$(lucky relation get user)&quot;
    dbpassword=&quot;$(lucky relation get password)&quot;

    # If any of those values have not be set yet, exit early and wait until next update
    if [ &quot;$dbhost&quot; = &quot;&quot; -o &quot;$dbport&quot; = &quot;&quot; -o &quot;$dbuser&quot; = &quot;&quot; -o &quot;$dbpassword&quot; = &quot;&quot; ]; then
        exit 0
    fi

    # Set database connection environment variable
    lucky container env set &quot;CMD_DB_URL=postgres://$dbuser:$dbpassword@$dbhost:$dbport/$db_name&quot;

    lucky set-status --name db-state active
</code></pre>
<p>When the database relation changes, we use <code>lucky relation get</code> to get the <code>host</code>, <code>port</code>, <code>user</code>, and <code>password</code> from the PostgreSQL relation. If any of those values are not set ( i.e. equal to <code>&quot;&quot;</code> ), then we <code>exit 0</code> and wait until the next <code>database-relation-changed</code> hook until those values are set. Once all values are set, we set our <code>CMD_DB_URL</code> environment variable in the container. This will make CodiMD connect to our database.</p>
<p>Once that environment variable has been added to the container, Lucky will be sure stop, remove, and re-create the container with the new environment variable. At that point, we should have a functional CodiMD instance! Still, we've got some other code to write and we'll finish that off before we try to run our charm.</p>
<h3><a class="header" href="#leaving-the-database-relation" id="leaving-the-database-relation">Leaving the Database Relation</a></h3>
<p>Disconnecting from our database relation is simple:</p>
<p><strong>lucky.yaml:</strong></p>
<pre><code class="language-yaml">  # When we are disconnected from a database
  database-relation-departed:
    # Run our database departed handler
    - host-script: handle-database-relation.sh
      args: [&quot;leave&quot;]
</code></pre>
<p><strong>handle-database-relation.sh:</strong></p>
<pre><code class="language-bash">elif [ &quot;$1&quot; = &quot;leave&quot; ]; then
    lucky set-status --name db-state maintenance &quot;Disconnecting from database&quot;

    # Unset database connection environment variable
    lucky container env set &quot;CMD_DB_URL=&quot;

    lucky set-status --name db-state blocked &quot;Waiting for database connection&quot;
fi
</code></pre>
<h2><a class="header" href="#handling-the-website-relation" id="handling-the-website-relation">Handling the Website Relation</a></h2>
<p>Now we are ready to handle our website relation.</p>
<p>It is worth noting that our CodiMD charm could work perfectly fine without providing a <code>website</code> relation. We could just as well access our CodiMD instance over the configured port and use <code>juju expose</code> to open the firewall ports so that we can get to it. The reason that we provide a website relation with the <code>http</code> interface is so that the user could choose to deploy CodiMD behind a reverse proxy such as <a href="https://jaas.ai/haproxy">Haproxy</a> or Katharos Technology's <a href="https://jaas.ai/u/katharostech/letsencrypt-proxy">Let's Encrypt Proxy</a> charm. Providing an http relation for CodiMD makes it compatible with the larger charming ecosystem and gives the user more deployment options.</p>
<blockquote>
<p><strong>Note:</strong> On the charm store you can view a <a href="https://jaas.ai/search?provides=http">list</a> of charms that take <code>http</code> relations.</p>
</blockquote>
<p>For our <code>lucky.yaml</code> we will need to add a new section for the <code>website-relation-joined</code> hook and, like our database handler, we use an argument to the script to indicate what kind of action to perform:</p>
<p><strong>lucky.yaml:</strong></p>
<pre><code class="language-yaml">  # When a new app is related to our website relation
  website-relation-joined:
    # Run our website join handler
    - host-script : handle-website-relation.sh
      args: [&quot;join&quot;]
</code></pre>
<p>Additionally we will need to add an extra script to our existing <code>config-changed</code> hook:</p>
<pre><code class="language-yaml">  config-changed:
    # Run our configure.sh host script
    - host-script: configure.sh 
    # Update our website relations with new config
    - host-script: handle-website-relation.sh
      args: [&quot;update&quot;]
</code></pre>
<p>This is what needs to go in our <code>handle-website-relation.sh</code> script:</p>
<p><strong>handle-website-relation.sh:</strong></p>
<pre><code class="language-bash">#!/bin/bash

set -e

# Here we match on the first argument ( $1 ) passed in from the lucky.yaml

# If we are joining a new relation
if [ &quot;$1&quot; = &quot;join&quot; ]; then
    lucky set-status maintenance &quot;Joining HTTP relation&quot;

    # Set hostname and port values for the joined relation
    lucky relation set \
        &quot;hostname=$(lucky private-address)&quot; \
        &quot;port=$(lucky get-config port)&quot;

# If we are supposed to update our existing relations
elif [ &quot;$1&quot; = &quot;update&quot; ]; then
    lucky set-status maintenance &quot;Updating HTTP relations&quot;

    # For every appliacation connected to or &quot;website&quot; relation
    for relation_id in $(lucky relation list-ids website); do
        # Set the hostname and port values for the relation
        lucky relation set --relation-id $relation_id \
            &quot;hostname=$(lucky private-address)&quot; \
            &quot;port=$(lucky get-config port)&quot;
    done
fi

lucky set-status active
</code></pre>
<p>As shown in the <a href="https://discourse.jujucharms.com/t/interface-http/2392"><code>http</code> interface documentation</a>, it is our job as the provider of an <code>http</code> relation to set the <code>hostname</code> and <code>port</code> values on our relation. In this script, we do this when we join the relation.</p>
<p>When our charm configuration changes, we have also configure in the <code>lucky.yaml</code> to run this script with the <code>update</code> arg. The goal here is to go through all of our <code>website</code> relations and <code>lucky relation set</code> the <code>hostname</code> and port to make sure it is up-to-date without our new config.</p>
<p>Note that because the <code>update</code> section of our script is triggered by the <code>config-changed</code> hook and is <strong>not</strong> a part of a relation hook, we need to get a list of all of the relation ids for our <code>website</code> relation and loop through them. For each relation id, we run <code>lucky relation set</code> and pass in the relation id. This way, any related applications that needed to know our hostname and port will be updated when our port changes.</p>
<h2><a class="header" href="#testing-our-charm" id="testing-our-charm">Testing Our Charm</a></h2>
<p>Congratulations, you have finished your first Lucky charm! That sums up everything you need to make a decent CodiMD charm with Lucky. You can find the full source for the charm <a href="https://github.com/katharostech/lucky/tree/master/docs/book/src/codimd-example-charm">here</a>. The last thing we need to do is test it. The beauty of the charm system is that, while it might be a little bit of work to write a charm, using the charm is <strong>super</strong> easy.</p>
<h3><a class="header" href="#building--deploying" id="building--deploying">Building &amp; Deploying</a></h3>
<p>Lucky charms mus be built before they can be deployed. This is very easy:</p>
<pre><code>lucky charm build
</code></pre>
<p>After that you will find the built charm in <code>./build/codimd</code>. This directory is what you need to deploy with Juju:</p>
<pre><code>juju deploy ./build/codimd
</code></pre>
<p>You will need to configure the domain and port for the codimd app before you can get to it. In this case the IP address is assumed to be the address of the server you depoyed CodiMD to. You will need to put the port in the domain as well if you are not hosting on port <code>80</code> or <code>443</code>:</p>
<pre><code>juju config codimd domain=10.176.159.221:3000 port=3000
</code></pre>
<p>After that settles our charm should show as <code>blocked</code> and &quot;Waiting for database connection&quot;. To fix that we deploy the PostgreSQL charm and relate it to our codimd charm.</p>
<pre><code>juju deploy postgresql
juju relate codimd postgresql:db
</code></pre>
<p>After PostgreSQL finishes deploying and configuring, you should be able to hit your new CodiMD instance on its IP and port. You're done!</p>
<blockquote>
<p><strong>Note:</strong> I've noticed that sometimes CodiMD doesn't seem to like it if the port that you are accessing it on is different than the port that you have set it to listen on. This <em>may</em> be a problem if you are running it behind a reverse proxy on port <code>443</code>, for instance, and CodiMD itself has <code>port=9000</code>. Some situations I tested like that <em>did</em> work so I don't know exactly what will work and what will not. That would be something to investigate if you wanted to actually <em>use</em> this CodiMD charm, but it doesn't hurt the effectiveness of our tutorial.</p>
</blockquote>
<h2><a class="header" href="#publishing-your-charm" id="publishing-your-charm">Publishing Your Charm</a></h2>
<p>OK, you were almost done, but now you want to share your charm creation with the world! To get a full guide on publishing charms to the store you can read the <a href="https://discourse.jujucharms.com/t/the-juju-charm-store/1045?u=zicklag">Juju Documentation</a>, but we'll go over the quick version here.</p>
<p>First you make sure you have built you charm:</p>
<pre><code>lucky charm build
</code></pre>
<p>Then we login to the charm store Juju's charm tools:</p>
<pre><code>charm login
</code></pre>
<p>Next we push our charm to the charm store under our account:</p>
<pre><code>$ charm push ./build/codimd codimd
cs:~username/codimd-0
</code></pre>
<blockquote>
<p><strong>Note:</strong> You cannot delete a charm from the store, once you have pushed it, without contacting the store administrators so be careful to get the charm name right the first time!</p>
</blockquote>
<p>This will push our charm to the store and print out the newly created revision of the charm. Now we release our charm to the stable channel:</p>
<pre><code>charm release cs:~username/codimd-0
</code></pre>
<p>And we grant read access to the charm to everyone:</p>
<pre><code>charm grant cs:~username/codimd everyone
</code></pre>
<p>You should now be able to see the charm in the public charm store at: <a href="https://jaas.ai/u/username/codimd/0">https://jaas.ai/u/username/codimd/0</a>.</p>
<p>Subsequent pushes of the charm will have the number at the end of the charm name incremented and they will need to be released individually to the stable channel once you have tested them:</p>
<pre><code class="language-bash"># Make changes to the charm
$ lucky charm build
$ charm push ./build/codimd codimd
cs:~username/codimd-1
$ charm release cs:~username/codimd-1
</code></pre>
<h2><a class="header" href="#wrapping-up" id="wrapping-up">Wrapping Up</a></h2>
<p>That's it for the tutorial. Very good job if you have made it this far! If you have any questions or you need help with something, do not hesitate to open a forum topic on the <a href="https://discourse.jujucharms.com/c/related-software/lucky">Juju forum</a>. We would appreciate any feedback on how Lucky worked for you or feedback on the documentation and this guide. Thank you for trying out Lucky!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="lucky-development/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="lucky-development/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
